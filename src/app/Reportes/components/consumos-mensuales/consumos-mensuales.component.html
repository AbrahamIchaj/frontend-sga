<div class="section-stack text-body">
  <div class="card">
    <div class="card-header">
      <h1 class="card-title">Consumos mensuales</h1>
      <p class="card-subtitle">
        Visualiza los despachos por día y analiza promedios móviles de consumo.
      </p>
    </div>
    <form
      [formGroup]="filtrosForm"
      class="filters-grid"
      (ngSubmit)="cargarDatos()"
    >
      <div class="form-field">
        <label for="anio" class="form-label">Año de cierre</label>
        <input
          id="anio"
          type="number"
          min="1500"
          class="form-control"
          formControlName="anio"
        />
      </div>
      <div class="form-field">
        <label for="mes" class="form-label">Mes (cierre 25)</label>
        <select id="mes" class="form-control" formControlName="mes">
          <option *ngFor="let mes of meses" [ngValue]="mes.valor">
            {{ mes.nombre | titlecase }}
          </option>
        </select>
      </div>
      <div class="form-field">
        <label for="renglon" class="form-label">Renglón</label>
        <select id="renglon" class="form-control" formControlName="renglon">
          <option value="">Todos</option>
          <option
            *ngFor="let renglon of renglonesDisponibles()"
            [ngValue]="renglon"
          >
            {{ renglon }}
          </option>
        </select>
      </div>
      <div class="form-actions flex items-center gap-3 md:justify-end">
        <button type="submit" class="btn btn-primary" [disabled]="cargando()">
          <i class="fas fa-sync-alt mr-2"></i>
          Actualizar
        </button>
        <button
          type="button"
          class="btn btn-secondary"
          [class.active]="mostrarPromedios()"
          (click)="abrirModalPromedios()"
          [disabled]="cargando() || cargandoPromedios()"
        >
          <i class="fas fa-chart-line mr-2"></i>
          Promedios mensuales
        </button>
        <button
          type="button"
          class="btn btn-secondary"
          (click)="limpiarFiltros()"
          [disabled]="cargando()"
        >
          Limpiar filtros
        </button>
      </div>
    </form>
  </div>

  <div class="status-card" *ngIf="cargando()">
    <i class="fas fa-spinner fa-spin mr-2"></i>
    Cargando información de consumos mensuales...
  </div>

  <ng-container *ngIf="!cargando()">
    <ng-container *ngIf="periodoActivo() as periodo; else sinDatos">
      <div class="grid-cards">
        <div class="metric-card">
          <span class="metric-label">Total de despachos</span>
          <span class="metric-value">{{ periodo.totalDespachos | number }}</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Unidades despachadas</span>
          <span class="metric-value">{{ periodo.totalCantidad | number : "1.0-0" }}</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Monto total</span>
          <span class="metric-value">
            {{ periodo.totalGeneral | currency : "GTQ" : "symbol" : "1.2-2" }}
          </span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Meses considerados</span>
          <span class="metric-value">{{ periodo.mesesConsiderados }}</span>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <ng-container [ngSwitch]="periodo.etiqueta">
            <ng-container *ngSwitchCase="'mensual'">
              <h2 class="card-title">Calendario de despachos (26 al 25)</h2>
              <p class="card-subtitle">
                Período del {{ periodo.fechaInicio | date : "dd/MM/yyyy" }} al
                {{ periodo.fechaFin | date : "dd/MM/yyyy" }}.
              </p>
            </ng-container>
            <ng-container *ngSwitchDefault>
              <h2 class="card-title">Promedios por insumo</h2>
              <p class="card-subtitle">
                Consolidado para {{ periodo.mesesConsiderados }} meses. Las
                columnas de promedio representan el consumo promedio mensual del
                período.
              </p>
            </ng-container>
          </ng-container>
        </div>

        <div
          class="periodo-selector flex flex-wrap justify-center items-center px-5 pb-5"
        >
          <button
            type="button"
            class="selector-btn"
            *ngFor="let opcion of periodosDisponibles()"
            [class.active]="periodoSeleccionado() === opcion.etiqueta"
            (click)="seleccionarPeriodo(opcion.etiqueta)"
          >
            {{ opcion.titulo }}
          </button>
        </div>

        <ng-container [ngSwitch]="periodo.etiqueta">
          <ng-container *ngSwitchCase="'mensual'">
            <div class="table-responsive calendario-wrapper">
              <table class="calendario-tabla">
                <thead>
                  <tr>
                    <th class="col-insumo">Insumo / Renglón</th>
                    <th *ngFor="let dia of diasCalendario()" class="col-dia">
                      <span class="dia-numero">{{ dia.dia }}</span>
                      <span class="dia-mes">{{ dia.nombreMes | slice : 0 : 3 }}</span>
                    </th>
                    <th class="col-total">Total</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngIf="filasCalendario().length === 0">
                    <td
                      [attr.colspan]="diasCalendario().length + 2"
                      class="text-muted text-center py-6"
                    >
                      No se encontraron despachos para el período seleccionado.
                    </td>
                  </tr>
                  <tr *ngFor="let fila of filasCalendario()">
                    <td class="col-insumo">
                      <div class="insumo-nombre">{{ fila.nombreInsumo }}</div>
                      <div class="insumo-detalle">
                        Código {{ fila.codigoInsumo }} · Renglón
                        {{ fila.renglon ?? "—" }}
                      </div>
                    </td>
                    <td
                      *ngFor="let dia of fila.valoresPorDia"
                      class="col-dia"
                      [class.con-consumo]="dia.totalCantidad > 0"
                    >
                      <span class="dia-cantidad" *ngIf="dia.totalCantidad > 0">
                        {{ dia.totalCantidad | number : "1.0-0" }}
                      </span>
                      <span class="dia-monto" *ngIf="dia.totalGeneral > 0">
                        {{ dia.totalGeneral | currency : "GTQ" : "symbol" : "1.0-0" }}
                      </span>
                    </td>
                    <td class="col-total">
                      <div class="total-cantidad">
                        {{ fila.totalCantidad | number : "1.0-0" }}
                      </div>
                      <div class="total-monto">
                        {{ fila.totalGeneral | currency : "GTQ" : "symbol" : "1.2-2" }}
                      </div>
                    </td>
                  </tr>
                </tbody>
                <tfoot *ngIf="periodo.resumenPorDia?.length">
                  <tr>
                    <th>Total diario</th>
                    <td
                      *ngFor="let dia of periodo.resumenPorDia"
                      class="col-dia total-dia"
                    >
                      <span class="dia-cantidad">
                        {{ dia.totalCantidad | number : "1.0-0" }}
                      </span>
                      <span class="dia-monto" *ngIf="dia.totalGeneral > 0">
                        {{ dia.totalGeneral | currency : "GTQ" : "symbol" : "1.0-0" }}
                      </span>
                    </td>
                    <td class="col-total">
                      <div class="total-cantidad">
                        {{ periodo.totalCantidad | number : "1.0-0" }}
                      </div>
                      <div class="total-monto">
                        {{ periodo.totalGeneral | currency : "GTQ" : "symbol" : "1.2-2" }}
                      </div>
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </ng-container>
          <ng-container *ngSwitchDefault>
            <div class="table-responsive">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Insumo</th>
                    <th>Total unidades</th>
                    <th>Promedio mensual unidades</th>
                    <th>Total monto</th>
                    <th>Promedio mensual monto</th>
                    <th>Total despachos</th>
                    <th>Promedio mensual despachos</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngIf="periodo.insumos.length === 0">
                    <td colspan="7" class="text-muted text-center py-6">
                      No se encontraron registros en el período seleccionado.
                    </td>
                  </tr>
                  <tr *ngFor="let insumo of periodo.insumos">
                    <td>
                      <div class="insumo-nombre">{{ insumo.nombreInsumo }}</div>
                      <div class="insumo-detalle">
                        Código {{ insumo.codigoInsumo }} · Renglón
                        {{ insumo.renglon ?? "—" }}
                      </div>
                    </td>
                    <td class="text-right">
                      {{ insumo.totalCantidad | number : "1.0-0" }}
                    </td>
                    <td class="text-right">
                      {{ insumo.promedioCantidad | number : "1.1-1" }}
                    </td>
                    <td class="text-right">
                      {{ insumo.totalGeneral | currency : "GTQ" : "symbol" : "1.2-2" }}
                    </td>
                    <td class="text-right">
                      {{ insumo.promedioGeneral | currency : "GTQ" : "symbol" : "1.2-2" }}
                    </td>
                    <td class="text-right">
                      {{ insumo.totalDespachos | number }}
                    </td>
                    <td class="text-right">
                      {{ insumo.promedioDespachos | number : "1.1-1" }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </ng-container>
        </ng-container>
      </div>
    </ng-container>
    <ng-template #sinDatos>
      <div class="status-card">
        <i class="fas fa-info-circle mr-2"></i>
        No hay datos para mostrar con los filtros seleccionados.
      </div>
    </ng-template>
  </ng-container>
</div>

<div
  *ngIf="mostrarPromedios()"
  class="fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4"
  role="dialog"
  aria-modal="true"
  aria-labelledby="promedios-modal-title"
  (click)="onBackdropClick($event)"
>
  <div class="promedios-modal" (click)="$event.stopPropagation()">
    <div class="promedios-modal__header">
      <div>
        <h2 id="promedios-modal-title" class="promedios-modal__title">
          Promedios mensuales por insumo
        </h2>
        <p class="promedios-modal__subtitle">
          Sumatoria de despachos por corte 26-25 durante el año
          {{ filtrosForm.value?.anio }}.
        </p>
      </div>
      <button
        type="button"
        class="promedios-modal__close"
        (click)="cerrarModalPromedios()"
        aria-label="Cerrar promedios mensuales"
      >
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="promedios-modal__body">
      <div *ngIf="cargandoPromedios()" class="promedios-modal__loading">
        <i class="fas fa-spinner fa-spin mr-2"></i>
        Calculando promedios mensuales...
      </div>
      <ng-container *ngIf="!cargandoPromedios()">
        <div class="table-responsive">
          <table class="data-table promedios-tabla">
            <thead>
              <tr>
                <th>Insumo</th>
                <th *ngFor="let mes of meses">
                  {{ mes.nombre | titlecase }}
                </th>
                <th>Promedio</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngIf="filasPromedios().length === 0">
                <td
                  [attr.colspan]="meses.length + 2"
                  class="text-muted text-center py-6"
                >
                  No se registraron despachos para el año seleccionado.
                </td>
              </tr>
              <tr *ngFor="let fila of filasPromedios()">
                <td>
                  <div class="insumo-nombre">{{ fila.nombreInsumo }}</div>
                  <div class="insumo-detalle">
                    Código {{ fila.codigoInsumo }} · Renglón
                    {{ fila.renglon ?? '—' }}
                  </div>
                  <div class="insumo-detalle" *ngIf="fila.caracteristicas">
                    {{ fila.caracteristicas }}
                  </div>
                </td>
                <td class="text-right" *ngFor="let valor of fila.valores">
                  {{ valor | number : '1.0-0' }}
                </td>
                <td class="text-right">
                  {{ fila.total | number : '1.0-0' }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </ng-container>
    </div>
  </div>
</div>
