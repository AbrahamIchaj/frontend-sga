<div class="historial-page">
  <div class="page-header simple-header">
    <div>
      <h1 class="page-title">Historial por fechas</h1>
      <p class="page-subtitle">
        Consulta los abastecimientos guardados seleccionando un rango de fechas.
      </p>
    </div>
    <div class="header-actions flex flex-wrap items-center gap-3">
      <label class="filtro-control">
        <span>Desde</span>
        <input
          type="date"
          class="rounded-lg border border-slate-500 bg-slate-800 px-3 py-2 text-sm text-slate-100 outline-none transition focus:border-blue-400 focus:ring-2 focus:ring-blue-500/60"
          [value]="fechaDesde()"
          (change)="onFechaDesdeChange($event)"
        />
      </label>
      <label class="filtro-control">
        <span>Hasta</span>
        <input
          type="date"
          class="rounded-lg border border-slate-500 bg-slate-800 px-3 py-2 text-sm text-slate-100 outline-none transition focus:border-blue-400 focus:ring-2 focus:ring-blue-500/60"
          [value]="fechaHasta()"
          (change)="onFechaHastaChange($event)"
        />
      </label>
      <button
        class="inline-flex items-center rounded-lg border border-blue-500 bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow transition hover:bg-blue-500"
        type="button"
        (click)="buscar()"
      >
        Aplicar rango
      </button>
      <button
        class="inline-flex items-center rounded-lg border border-slate-600 px-4 py-2 text-sm font-semibold text-slate-200 transition hover:border-slate-300 hover:text-white"
        type="button"
        (click)="aplicarSemanaActual()"
      >
        Semana actual
      </button>
      <button
        class="inline-flex items-center rounded-lg border border-slate-600 px-4 py-2 text-sm font-semibold text-slate-200 transition hover:border-slate-300 hover:text-white"
        type="button"
        (click)="aplicarSemanaAnterior()"
      >
        Semana anterior
      </button>
      <button
        class="inline-flex items-center rounded-lg border border-slate-600 px-4 py-2 text-sm font-semibold text-slate-200 transition hover:border-slate-300 hover:text-white disabled:cursor-not-allowed disabled:opacity-60"
        type="button"
        (click)="limpiar()"
        [disabled]="!registros().length && !fechaDesde() && !fechaHasta()"
      >
        Limpiar
      </button>
      <a
        class="inline-flex items-center rounded-lg border border-transparent bg-slate-700/70 px-4 py-2 text-sm font-semibold text-slate-100 shadow transition hover:bg-slate-600"
        routerLink="/abastecimientos/historial"
        >Ver por mes</a
      >
      <a
        class="inline-flex items-center rounded-lg border border-blue-500 bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow transition hover:bg-blue-500"
        routerLink="/abastecimientos"
        >Volver al módulo</a
      >
    </div>
  </div>

  <section
    class="resumen-aplicado"
    *ngIf="fechaAplicadaDesde() && fechaAplicadaHasta() && !error()"
  >
    <span>Resultados entre</span>
    <strong
      >{{ fechaAplicadaDesde() | date:'longDate':'':'es' }} y {{ fechaAplicadaHasta() |
      date:'longDate':'':'es' }}</strong
    >
    <span>({{ registros().length }} registros)</span>
  </section>

  <div class="estado" *ngIf="loading()">
    <div class="loader"></div>
    <p>Cargando registros guardados...</p>
  </div>

  <div class="estado estado-error" *ngIf="!loading() && error()">
    <p>{{ error() }}</p>
  </div>

  <div
    class="estado estado-vacio"
    *ngIf="!loading() && !error() && !registros().length"
  >
    <p>No se encontraron registros guardados para el rango seleccionado.</p>
  </div>

  <section
    class="historial-grid"
    *ngIf="!loading() && !error() && registros().length"
  >
    <article
      class="registro-card"
      *ngFor="let registro of registros(); trackBy: trackByRegistro"
    >
      <header class="registro-card__header">
        <div>
          <h2>{{ registro.fechaConsulta | date:'fullDate':'':'es' }}</h2>
          <p>
            Periodo asociado: {{ registro.anio }} · {{ registro.mes |
            number:'2.0-0' }}
          </p>
        </div>
        <div class="registro-meta">
          <span class="chip">{{ registro.resumen.totalInsumos }} insumos</span>
          <span class="chip chip-disponible"
            >Disp. {{ registro.cobertura.disponibilidad | number:'1.0-2'
            }}%</span
          >
          <span class="chip chip-abastecido"
            >Abast. {{ registro.cobertura.abastecimiento | number:'1.0-2'
            }}%</span
          >
        </div>
      </header>

      <section class="registro-resumen">
        <div class="dato">
          <span>Total activos</span>
          <strong>{{ registro.resumen.activos }}</strong>
        </div>
        <div class="dato">
          <span>Total inactivos</span>
          <strong>{{ registro.resumen.inactivos }}</strong>
        </div>
        <div class="dato">
          <span>Existencias bodega</span>
          <strong
            >{{ registro.resumen.existenciasBodegaActual | number:'1.0-0'
            }}</strong
          >
        </div>
        <div class="dato">
          <span>Existencias cocina</span>
          <strong
            >{{ registro.resumen.existenciasCocinaRegistrada | number:'1.0-0'
            }}</strong
          >
        </div>
        <div class="dato">
          <span>Valor inventario</span>
          <strong
            >{{ registro.resumen.valorInventarioEstimado |
            currency:'GTQ':'symbol':'1.2-2' }}</strong
          >
        </div>
        <div class="dato">
          <span>Meses prom.</span>
          <strong
            >{{ registro.resumen.promedioMesesCobertura | number:'1.1-1'
            }}</strong
          >
        </div>
      </section>

      <section
        class="registro-analisis analisis"
        *ngIf="registro.cobertura?.filas?.length"
      >
        <header class="analisis__header">
          <h3>Análisis lista básica</h3>
        </header>
        <div class="analisis__body">
          <table class="analisis__tabla">
            <thead>
              <tr>
                <th>Meses de existencia disponible</th>
                <th class="numero">Cantidad de insumos</th>
                <th class="numero">Porcentaje %</th>
              </tr>
            </thead>
            <tbody>
              <tr
                *ngFor="let fila of registro.cobertura.filas; let i = index"
                [ngClass]="'rango-' + i"
              >
                <td>{{ fila.etiqueta }}</td>
                <td class="numero">{{ fila.cantidad }}</td>
                <td class="numero">{{ fila.porcentaje | number:'1.2-2' }}</td>
              </tr>
            </tbody>
            <tfoot>
              <tr class="total-row">
                <td>Total</td>
                <td class="numero">{{ registro.cobertura.totalCantidad }}</td>
                <td class="numero">
                  {{ registro.cobertura.totalPorcentaje | number:'1.2-2' }}
                </td>
              </tr>
            </tfoot>
          </table>
          <div class="analisis__resumen">
            <div class="analisis-card disponibilidad">
              <span class="analisis-card__label">
                % de insumos de la lista básica mayor a 1 mes de existencia
              </span>
              <span class="analisis-card__valor">
                {{ registro.cobertura.disponibilidad | number:'1.2-2' }}%
              </span>
              <span class="analisis-card__tag">Disponibilidad</span>
            </div>
            <div class="analisis-card abastecimiento">
              <span class="analisis-card__label">
                % de insumos de la lista básica mayor o igual a 3 meses de
                existencia
              </span>
              <span class="analisis-card__valor">
                {{ registro.cobertura.abastecimiento | number:'1.2-2' }}%
              </span>
              <span class="analisis-card__tag">Abastecimiento</span>
            </div>
          </div>
        </div>
      </section>

      <section class="registro-insumos">
        <header class="registro-insumos__header">
          <h3>Detalle de insumos ({{ registro.insumos.length }})</h3>
        </header>
        <div class="tabla-wrapper">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Código</th>
                <th>Nombre</th>
                <th>Exist. bodega</th>
                <th>Exist. cocina</th>
                <th>Total unidades</th>
                <th>Consumo mensual</th>
                <th>Meses cobertura</th>
                <th>Valor estimado</th>
                <th>Activo</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let insumo of registro.insumos; let i = index">
                <td>{{ i + 1 }}</td>
                <td>{{ insumo.codigoInsumo }}</td>
                <td>
                  <div class="nombre">
                    {{ insumo.nombreInsumo || 'Sin nombre' }}
                  </div>
                  <div class="detalle">
                    {{ insumo.caracteristicas || 'Sin descripción' }}
                  </div>
                  <div class="detalle" *ngIf="insumo.presentacion">
                    {{ insumo.presentacion }} · {{ insumo.unidadMedida || 'Sin
                    unidad' }}
                  </div>
                </td>
                <td>{{ insumo.existenciasBodega | number:'1.0-0' }}</td>
                <td>{{ insumo.existenciasCocina | number:'1.0-0' }}</td>
                <td>{{ obtenerTotalUnidades(insumo) | number:'1.0-0' }}</td>
                <td>{{ obtenerConsumoMensual(insumo) | number:'1.1-1' }}</td>
                <td>{{ calcularMesesCobertura(insumo) | number:'1.1-1' }}</td>
                <td>
                  {{ obtenerValorEstimado(insumo) |
                  currency:'GTQ':'symbol':'1.2-2' }}
                </td>
                <td>
                  <span
                    class="estado-chip"
                    [ngClass]="insumo.activo ? 'activo' : 'inactivo'"
                    >{{ insumo.activo ? 'Sí' : 'No' }}</span
                  >
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </article>
  </section>
</div>
