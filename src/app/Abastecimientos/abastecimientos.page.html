<div class="abastecimientos-page">
  <div class="page-header simple-header">
    <div>
      <h1 class="page-title">Abastecimientos</h1>
      <p class="page-subtitle">Guarda los periodos de abastecimiento.</p>
    </div>
    <div class="header-actions">
      <label class="fecha-label">
        <span>Seleccionar fecha:</span>
        <input
          type="date"
          [value]="fechaConsulta()"
          (change)="onFechaChange($event)"
        />
      </label>
      <button class="btn-ghost" type="button" (click)="cargar()">
        Actualizar
      </button>
      <a class="btn-secundario" routerLink="/abastecimientos/historial"
        >Ver historial</a
      >
      <button class="btn-primario" type="button" (click)="guardar()">
        Guardar periodo
      </button>
    </div>
  </div>

  <section class="analisis" *ngIf="cobertura().filas.length">
    <header class="analisis__header">
      <h2>Análisis lista básica</h2>
    </header>
    <div class="analisis__body">
      <table class="analisis__tabla">
        <thead>
          <tr>
            <th>Meses de existencia disponible</th>
            <th class="numero">Cantidad de insumos</th>
            <th class="numero">Porcentaje %</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let fila of cobertura().filas; let i = index"
            [ngClass]="'rango-' + i"
          >
            <td>{{ fila.etiqueta }}</td>
            <td class="numero">{{ fila.cantidad }}</td>
            <td class="numero">{{ fila.porcentaje | number:'1.2-2' }}</td>
          </tr>
        </tbody>
        <tfoot>
          <tr class="total-row">
            <td>Total</td>
            <td class="numero">{{ cobertura().totalCantidad }}</td>
            <td class="numero">
              {{ cobertura().totalPorcentaje | number:'1.2-2' }}
            </td>
          </tr>
        </tfoot>
      </table>
      <div class="analisis__resumen">
        <div class="analisis-card disponibilidad">
          <span class="analisis-card__label"
            >% de insumos de la lista básica mayor a 1 mes de existencia</span
          >
          <span class="analisis-card__valor"
            >{{ cobertura().disponibilidad | number:'1.2-2' }}%</span
          >
          <span class="analisis-card__tag">Disponibilidad</span>
        </div>
        <div class="analisis-card abastecimiento">
          <span class="analisis-card__label"
            >% de insumos de la lista básica mayor o igual a 3 meses de
            existencia</span
          >
          <span class="analisis-card__valor"
            >{{ cobertura().abastecimiento | number:'1.2-2' }}%</span
          >
          <span class="analisis-card__tag">Abastecimiento</span>
        </div>
      </div>
    </div>
  </section>

  <div class="estado" *ngIf="loading()">
    <div class="loader"></div>
    <p>Cargando información del periodo...</p>
  </div>

  <div class="estado estado-error" *ngIf="!loading() && error()">
    <p>{{ error() }}</p>
  </div>

  <div
    class="estado estado-vacio"
    *ngIf="!loading() && !error() && !items().length"
  >
    <p>No hay insumos registrados para el periodo seleccionado.</p>
  </div>

  <div class="tabla-wrapper" *ngIf="!loading() && !error() && items().length">
    <table class="tabla-abastecimientos">
      <thead>
        <tr>
          <th>No.</th>
          <th>Renglón</th>
          <th>Código</th>
          <th>Nombre</th>
          <th>Exist. bodega</th>
          <th>Exist. cocina</th>
          <th>Total unidades</th>
          <th>Promedio mensual</th>
          <th>Meses abastecimiento</th>
          <th>Valor promedio</th>
          <th>Activo</th>
        </tr>
      </thead>
      <tbody>
        <tr
          *ngFor="let item of items(); trackBy: trackporCodigo; let i = index"
          [ngClass]="{ 'fila-inactiva': !item.edit.activo }"
        >
          <td class="numero">{{ i + 1 }}</td>
          <td class="numero">{{ item.renglon }}</td>
          <td class="codigo">{{ item.codigoInsumo }}</td>
          <td>
            <div class="nombre">{{ item.nombreInsumo }}</div>
            <div class="detalle">
              {{ item.caracteristicas || 'Sin descripción' }}
            </div>
            <div class="detalle" *ngIf="item.presentacion">
              {{ item.presentacion }} · {{ item.unidadMedida || 'Sin unidad' }}
            </div>
          </td>
          <td class="numero">
            {{ item.edit.existenciasBodega | number:'1.0-0' }}
          </td>
          <td>
            <input
              class="input-mini"
              type="number"
              min="0"
              [value]="item.edit.existenciasCocina"
              (input)="onCocinaChange(item, $event)"
            />
          </td>
          <td class="numero">
            {{ item.totals.existenciasTotales | number:'1.0-0' }}
          </td>
          <td class="numero">{{ consumoMensual(item) | number:'1.1-1' }}</td>
          <td>
            <span
              class="badge"
              [ngClass]="badgeCobertura(item.totals.mesesAbastecimiento)"
            >
              {{ item.totals.mesesAbastecimiento | number:'1.1-1' }} meses
            </span>
          </td>
          <td>
            <!-- <input
              class="input-mini"
              type="number"
              min="0"
              step="0.01"
              [value]="item.edit.precioUnitario ?? ''"
              (input)="onPrecioChange(item, $event)"
              placeholder="0.00"
              readonly="false"
            /> -->
            <div class="detalle valor-total" *ngIf="item.totals.costoTotal">
              {{ 'Q.' + (item.totals.costoTotal | number:'1.2-2') }}
            </div>
          </td>
          <td>
            <span
              class="estado-chip"
              [ngClass]="item.edit.activo ? 'activo' : 'inactivo'"
            >
              {{ item.edit.activo ? 'Activo' : 'Inactivo' }}
            </span>
            <button
              class="estado-toggle"
              type="button"
              (click)="toggleActivo(item)"
            >
              {{ item.edit.activo ? 'Desactivar' : 'Activar' }}
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
