<form
  class="p-6 space-y-6"
  [formGroup]="reajusteForm"
  (ngSubmit)="enviar()"
  novalidate
>
  <div
    class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between"
  >
    <div>
      <h1 class="text-2xl font-semibold text-white">
        Nuevo reajuste de inventario
      </h1>
      <p class="text-sm text-gray-400">
        Registra entradas o salidas manuales para ajustar las existencias de
        productos en inventario.
      </p>
    </div>
    <button
      type="button"
      (click)="cancelar()"
      class="inline-flex items-center gap-2 rounded-lg border border-gray-600 px-3 py-2 text-xs font-medium text-gray-300 hover:border-gray-500 hover:text-white"
    >
      <span class="material-icons text-base">arrow_back</span>
      Volver al listado
    </button>
  </div>

  <section class="rounded-xl border border-gray-700 bg-gray-900/70 p-6 shadow">
    <h2 class="text-lg font-semibold text-gray-100">Información general</h2>
    <p class="text-xs text-gray-400">
      Define los datos principales del reajuste.
    </p>

    <div class="mt-4 grid gap-4 md:grid-cols-2">
      <div>
        <label class="mb-1 block text-sm font-medium text-gray-300"
          >Fecha y hora</label
        >
        <input
          type="datetime-local"
          formControlName="fechaReajuste"
          class="w-full rounded-lg border border-gray-600 bg-gray-900 px-3 py-2 text-sm text-gray-100 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-600/40"
        />
        <div
          class="mt-1 text-xs text-red-400"
          *ngIf="
            reajusteForm.get('fechaReajuste')?.invalid &&
            reajusteForm.get('fechaReajuste')?.touched
          "
        >
          Selecciona una fecha válida.
        </div>
      </div>

      <div>
        <label class="mb-1 block text-sm font-medium text-gray-300"
          >Tipo de reajuste</label
        >
        <select
          formControlName="tipoReajuste"
          readonly
          class="w-full rounded-lg border border-gray-600 bg-gray-900 px-3 py-2 text-sm text-gray-100 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-600/40"
        >
          <option value="1">Positivo</option>
        </select>
      </div>

      <div>
        <label class="mb-1 block text-sm font-medium text-gray-300"
          >Referencia del documento</label
        >
        <input
          type="text"
          maxlength="{{ maxReferencia }}"
          formControlName="referenciaDocumento"
          placeholder="Ingresar no. referencia, requisicón, documento, etc."
          class="w-full rounded-lg border border-gray-600 bg-gray-900 px-3 py-2 text-sm text-gray-100 placeholder-gray-500 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-600/40"
        />
        <div
          class="mt-1 text-xs text-red-400"
          *ngIf="
            reajusteForm.get('referenciaDocumento')?.invalid &&
            reajusteForm.get('referenciaDocumento')?.touched
          "
        >
          La referencia es obligatoria y no debe exceder
          {{ maxReferencia }} caracteres.
        </div>
      </div>

      <div>
        <label class="mb-1 block text-sm font-medium text-gray-300"
          >Observaciones</label
        >
        <textarea
          rows="3"
          formControlName="observaciones"
          placeholder="Notas adicionales, motivo del ajuste, etc."
          class="w-full rounded-lg border border-gray-600 bg-gray-900 px-3 py-2 text-sm text-gray-100 placeholder-gray-500 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-600/40"
        ></textarea>
      </div>
    </div>
  </section>

  <section
    class="rounded-xl border border-gray-700 bg-gray-900/70 p-6 shadow space-y-4"
  >
    <div
      class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between"
    >
      <div>
        <h2 class="text-lg font-semibold text-gray-100">
          Detalle del reajuste
        </h2>
        <p class="text-xs text-gray-400">
          Busca insumos o productos para agregarlos al reajuste.
        </p>
      </div>
    </div>

    <div class="flex flex-wrap items-center gap-2 text-xs text-gray-400">
      <span class="font-semibold uppercase tracking-wide"
        >Modo de ingreso:</span
      >
      <div
        class="inline-flex overflow-hidden rounded-lg border border-gray-700 bg-gray-800/70"
      >
        <button
          type="button"
          (click)="cambiarModoIngreso('catalogo')"
          [ngClass]="
            modoIngreso === 'catalogo'
              ? 'bg-emerald-500 text-white'
              : 'text-gray-300 hover:text-white'
          "
          class="px-3 py-2 text-xs font-semibold transition"
        >
          Buscar en catálogo
        </button>
        <button
          type="button"
          (click)="cambiarModoIngreso('manual')"
          [ngClass]="
            modoIngreso === 'manual'
              ? 'bg-emerald-500 text-white'
              : 'text-gray-300 hover:text-white'
          "
          class="border-l border-gray-700 px-3 py-2 text-xs font-semibold transition"
        >
          Ingreso manual
        </button>
      </div>
    </div>

    <div
      class="grid gap-3 md:grid-cols-[minmax(0,1fr)_auto] md:items-end"
      *ngIf="modoIngreso === 'catalogo'"
    >
      <div class="grid gap-3 md:grid-cols-2">
        <!-- <div class="md:col-span-2">
          <label class="mb-1 block text-sm font-medium text-gray-300"
            >Buscar insumo (nombre, características, presentación)</label
          >
          <input
            type="text"
            name="catalogoBusqueda"
            [ngModel]="catalogoBusqueda"
            [ngModelOptions]="{ standalone: true }"
            (ngModelChange)="onCatalogoInput($event)"
            placeholder="Ej: guantes, jeringa, solución"
            class="w-full rounded-lg border border-gray-600 bg-gray-900 px-3 py-2 text-sm text-gray-100 placeholder-gray-500 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-600/40"
          />
        </div> -->
        <div>
          <label class="mb-1 block text-sm font-medium text-gray-300"
            >Buscar por código (opcional)</label
          >
          <div class="flex gap-2">
            <input
              type="text"
              inputmode="numeric"
              pattern="[0-9]*"
              name="codigoBusqueda"
              [(ngModel)]="codigoBusqueda"
              [ngModelOptions]="{ standalone: true }"
              placeholder="Ej: 101"
              class="w-full rounded-lg border border-gray-600 bg-gray-900 px-3 py-2 text-sm text-gray-100 placeholder-gray-500 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-600/40"
            />
            <button
              type="button"
              (click)="buscarCatalogoPorCodigo()"
              class="rounded-lg bg-emerald-500 px-3 py-2 text-xs font-semibold text-white shadow hover:bg-emerald-600"
            >
              Buscar
            </button>
          </div>
        </div>
        <div class="text-xs text-gray-500" *ngIf="!esEntrada">
          Para salidas, verifica previamente la disponibilidad en inventario.
        </div>
      </div>
    </div>

    <div
      *ngIf="modoIngreso === 'manual'"
      class="rounded-lg border border-amber-500/30 bg-amber-500/10 p-4 text-sm text-amber-100"
    >
      <p>
        Ingresa manualmente un insumo que no esté registrado en el catálogo o
        que no cuente con un código identificado.
      </p>
      <div class="mt-3 flex flex-wrap gap-2">
        <button
          type="button"
          (click)="iniciarDetalleManual()"
          class="rounded-lg bg-amber-500 px-3 py-2 text-xs font-semibold text-gray-900 shadow hover:bg-amber-400"
        >
          Agregar insumo manual
        </button>
        <span class="text-xs text-amber-200">
          El código es opcional; completa el nombre y las características para
          continuar.
        </span>
      </div>
    </div>

    <div
      *ngIf="buscandoCatalogo"
      class="rounded-lg border border-emerald-500/30 bg-emerald-500/10 p-3 text-sm text-emerald-200"
    >
      Buscando insumos...
    </div>
    <div
      *ngIf="errorBusqueda"
      class="rounded-lg border border-yellow-500/30 bg-yellow-500/10 p-3 text-xs text-yellow-200"
    >
      {{ errorBusqueda }}
    </div>

    <div *ngIf="catalogoResultados.length" class="grid gap-3 md:grid-cols-2">
      <button
        type="button"
        *ngFor="let item of catalogoResultados"
        (click)="seleccionarCatalogo(item)"
        class="rounded-lg border border-gray-700 bg-gray-800/70 px-4 py-3 text-left text-sm text-gray-100 hover:border-emerald-500"
      >
        <div class="font-semibold text-white">
          {{ item.codigoInsumo }} - {{ item.nombreInsumo }}
        </div>
        <div class="text-xs text-gray-400">{{ item.caracteristicas }}</div>
        <div class="mt-1 text-xs text-gray-500">
          {{ item.nombrePresentacion || "Sin presentación" }} ·
          {{ item.unidadMedida || "Unidad" }}
        </div>
      </button>
    </div>

    <div
      *ngIf="detalleForm"
      [formGroup]="detalleForm"
      class="rounded-lg border border-emerald-500/40 bg-emerald-500/5 p-5 text-sm text-gray-100"
    >
      <div class="flex items-start justify-between gap-4">
        <div>
          <h3 class="text-base font-semibold text-emerald-200">
            {{ detalleForm.get("nombreInsumo")?.value }}
          </h3>
          <p class="text-xs text-gray-300">
            {{ detalleForm.get("caracteristicas")?.value }}
          </p>
        </div>
        <button
          type="button"
          (click)="cancelarEdicion()"
          class="text-xs text-gray-400 hover:text-gray-200"
        >
          Cerrar
        </button>
      </div>

      <div class="mt-4 grid gap-4 md:grid-cols-4">
        <div>
          <label class="mb-1 block text-xs font-medium text-gray-300"
            >Código de insumo</label
          >
          <input
            type="number"
            min="1"
            formControlName="codigoInsumo"
            [readonly]="!esDetalleManual"
            class="w-full rounded-lg border border-gray-600 bg-gray-900 px-3 py-2 text-sm text-gray-100 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/40 disabled:cursor-not-allowed"
          />
          <div class="mt-1 text-xs text-gray-400">
            Opcional: deja en blanco si el insumo no tiene código.
          </div>
        </div>
        <div>
          <label class="mb-1 block text-xs font-medium text-gray-300"
            >Cantidad</label
          >
          <input
            type="number"
            min="1"
            formControlName="cantidad"
            class="w-full rounded-lg border border-gray-600 bg-gray-900 px-3 py-2 text-sm text-gray-100 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/40"
          />
        </div>

        <div class="md:col-span-2">
          <label class="mb-1 block text-xs font-medium text-gray-300"
            >Precio unitario</label
          >
          <input
            type="number"
            min="0"
            step="0.01"
            formControlName="precioUnitario"
            [readonly]="!esEntrada"
            class="w-full rounded-lg border border-gray-600 bg-gray-900 px-3 py-2 text-sm text-gray-100 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/40 disabled:cursor-not-allowed"
          />
          <div class="mt-1 text-xs text-gray-400" *ngIf="!esEntrada">
            Se usa el precio registrado en inventario para salidas.
          </div>
        </div>

        <div>
          <label class="mb-1 block text-xs font-medium text-gray-300"
            >Lote</label
          >
          <input
            type="text"
            formControlName="lote"
            placeholder="Lote (opcional)"
            class="w-full rounded-lg border border-gray-600 bg-gray-900 px-3 py-2 text-sm text-gray-100 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/40"
          />
        </div>

        <div>
          <label class="mb-1 block text-xs font-medium text-gray-300"
            >Fecha de vencimiento</label
          >
          <input
            type="date"
            formControlName="fechaVencimiento"
            class="w-full rounded-lg border border-gray-600 bg-gray-900 px-3 py-2 text-sm text-gray-100 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/40"
          />
        </div>

        <div class="md:col-span-2">
          <label class="mb-1 block text-xs font-medium text-gray-300"
            >Nombre del insumo</label
          >
          <input
            type="text"
            formControlName="nombreInsumo"
            placeholder="Nombre del producto"
            [readonly]="!esDetalleManual"
            class="w-full rounded-lg border border-gray-600 bg-gray-900 px-3 py-2 text-sm text-gray-100 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/40"
          />
        </div>

        <div>
          <label class="mb-1 block text-xs font-medium text-gray-300"
            >Presentación</label
          >
          <input
            type="text"
            formControlName="presentacion"
            placeholder="Ej: Caja, frasco, unidad"
            [readonly]="!esDetalleManual"
            class="w-full rounded-lg border border-gray-600 bg-gray-900 px-3 py-2 text-sm text-gray-100 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/40"
          />
        </div>

        <div>
          <label class="mb-1 block text-xs font-medium text-gray-300"
            >Unidad de medida</label
          >
          <input
            type="text"
            formControlName="unidadMedida"
            placeholder="Ej: ml, unidades, caja"
            [readonly]="!esDetalleManual"
            class="w-full rounded-lg border border-gray-600 bg-gray-900 px-3 py-2 text-sm text-gray-100 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/40"
          />
        </div>

        <div class="md:col-span-4">
          <label class="mb-1 block text-xs font-medium text-gray-300"
            >Características</label
          >
          <textarea
            rows="2"
            formControlName="caracteristicas"
            placeholder="Descripción o detalles del insumo"
            [readonly]="!esDetalleManual"
            class="w-full rounded-lg border border-gray-600 bg-gray-900 px-3 py-2 text-sm text-gray-100 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/40"
          ></textarea>
        </div>

        <div class="md:col-span-2">
          <label class="mb-1 block text-xs font-medium text-gray-300"
            >Observaciones</label
          >
          <input
            type="text"
            formControlName="observaciones"
            placeholder="Observaciones adicionales (opcional)"
            class="w-full rounded-lg border border-gray-600 bg-gray-900 px-3 py-2 text-sm text-gray-100 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/40"
          />
        </div>

        <div>
          <label class="mb-1 block text-xs font-medium text-gray-300"
            >Carta compromiso</label
          >
          <select
            formControlName="cartaCompromiso"
            class="w-full rounded-lg border border-gray-600 bg-gray-900 px-3 py-2 text-sm text-gray-100 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/40"
          >
            <option [ngValue]="false">No</option>
            <option [ngValue]="true">Sí</option>
          </select>
        </div>

        <div>
          <label class="mb-1 block text-xs font-medium text-gray-300"
            >Meses devolución</label
          >
          <select
            formControlName="tipoReajuste"
            readonly
            class="w-full rounded-lg border border-gray-600 bg-gray-900 px-3 py-2 text-sm text-gray-100 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-600/40"
          >
            <option>Ninguno</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="6">6</option>
            <option value="9">9</option>
            <option value="12">12</option>
          </select>
        </div>

        <div class="md:col-span-2">
          <label class="mb-1 block text-xs font-medium text-gray-300"
            >Observaciones devolución</label
          >
          <input
            type="text"
            formControlName="observacionesDevolucion"
            placeholder="Información adicional"
            class="w-full rounded-lg border border-gray-600 bg-gray-900 px-3 py-2 text-sm text-gray-100 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/40"
          />
        </div>
      </div>

      <div
        *ngIf="detalleStockDisponible !== null"
        class="mt-3 rounded-lg border border-orange-500/30 bg-orange-500/10 p-3 text-xs text-orange-200"
      >
        Existencias actuales para este insumo:
        <strong>{{ detalleStockDisponible }}</strong> unidades.
      </div>

      <div class="mt-5 flex items-center justify-end gap-3">
        <button
          type="button"
          (click)="cancelarEdicion()"
          class="rounded-lg border border-gray-600 px-3 py-2 text-xs font-medium text-gray-300 hover:border-gray-500 hover:text-white"
        >
          Cancelar
        </button>
        <button
          type="button"
          (click)="guardarDetalle()"
          class="rounded-lg bg-emerald-500 px-4 py-2 text-xs font-semibold text-white shadow hover:bg-emerald-600"
        >
          {{
            detalleEditIndex !== null
              ? "Actualizar detalle"
              : "Agregar al reajuste"
          }}
        </button>
      </div>
    </div>

    <div class="overflow-x-auto rounded-lg border border-gray-800">
      <table class="min-w-full divide-y divide-gray-800 text-sm text-gray-200">
        <thead
          class="bg-gray-800/70 text-xs font-semibold uppercase tracking-wide text-gray-400"
        >
          <tr>
            <th class="px-4 py-3 text-left">Código</th>
            <th class="px-4 py-3 text-left">Descripción</th>
            <th class="px-4 py-3 text-left">Lote</th>
            <th class="px-4 py-3 text-left">Fecha venc.</th>
            <th class="px-4 py-3 text-center">Cantidad</th>
            <th class="px-4 py-3 text-right">Precio unitario</th>
            <th class="px-4 py-3 text-right">Subtotal</th>
            <th class="px-4 py-3 text-right">Acciones</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-900">
          <tr
            *ngFor="let detalle of detallesControles; let i = index"
            [formGroup]="detalle"
            class="hover:bg-gray-800/60"
          >
            <td class="px-4 py-3">
              <div class="font-semibold text-white">
                {{ detalle.get("codigoInsumo")?.value || "—" }}
              </div>
              <div class="text-xs text-gray-400">
                {{ detalle.get("nombreInsumo")?.value }}
              </div>
            </td>
            <td class="px-4 py-3 text-xs text-gray-300">
              {{ detalle.get("caracteristicas")?.value }}
              <div
                *ngIf="detalle.get('observaciones')?.value"
                class="mt-1 text-xs italic text-gray-500"
              >
                {{ detalle.get("observaciones")?.value }}
              </div>
              <div
                *ngIf="
                  detalle.get('presentacion')?.value ||
                  detalle.get('unidadMedida')?.value
                "
                class="mt-1 text-xs text-gray-500"
              >
                {{ detalle.get("presentacion")?.value || "Sin presentación" }} ·
                {{ detalle.get("unidadMedida")?.value || "Unidad" }}
              </div>
            </td>
            <td class="px-4 py-3 text-xs text-gray-300">
              {{ detalle.get("lote")?.value || "—" }}
            </td>
            <td class="px-4 py-3 text-xs text-gray-300">
              {{ detalle.get("fechaVencimiento")?.value || "—" }}
            </td>
            <td class="px-4 py-3 text-center font-semibold text-white">
              {{ detalle.get("cantidad")?.value }}
            </td>
            <td class="px-4 py-3 text-right">
              {{ detalle.get("precioUnitario")?.value | quetzales : true }}
            </td>
            <td class="px-4 py-3 text-right">
              {{
                (detalle.get("cantidad")?.value || 0) *
                  (detalle.get("precioUnitario")?.value || 0) | quetzales : true
              }}
            </td>
            <td class="px-4 py-3 text-right">
              <div class="flex items-center justify-end gap-2">
                <button
                  type="button"
                  (click)="editarDetalle(i)"
                  class="rounded-lg border border-gray-600 px-3 py-1 text-xs text-gray-300 hover:border-emerald-500 hover:text-emerald-300"
                >
                  Editar
                </button>
                <button
                  type="button"
                  (click)="eliminarDetalle(i)"
                  class="rounded-lg border border-red-500/60 px-3 py-1 text-xs text-red-300 hover:bg-red-500/10"
                >
                  Eliminar
                </button>
              </div>
            </td>
          </tr>
          <tr *ngIf="!detallesArray.length">
            <td colspan="8" class="px-4 py-8 text-center text-sm text-gray-400">
              Aún no has agregado detalles al reajuste.
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div
      class="flex flex-col gap-2 rounded-lg border border-gray-800 bg-gray-900/60 px-4 py-3 text-sm text-gray-200 md:flex-row md:items-center md:justify-between"
    >
      <div>
        <span class="font-semibold text-white">Total de líneas:</span>
        {{ totalLineas }}
      </div>
      <div>
        <span class="font-semibold text-white">Total unidades:</span>
        {{ totalCantidad }}
      </div>
      <div>
        <span class="font-semibold text-white">Valor estimado:</span>
        {{ totalValor | quetzales : true }}
      </div>
    </div>
  </section>

  <div
    class="flex flex-col gap-3 border-t border-gray-800 pt-4 md:flex-row md:justify-end"
  >
    <button
      type="button"
      (click)="cancelar()"
      class="rounded-lg border border-gray-600 px-4 py-2 text-sm font-medium text-gray-300 hover:border-gray-500 hover:text-white"
    >
      Cancelar
    </button>
    <button
      type="submit"
      [disabled]="enviando"
      class="inline-flex items-center justify-center gap-2 rounded-lg bg-emerald-500 px-5 py-2 text-sm font-semibold text-white shadow hover:bg-emerald-600 disabled:cursor-not-allowed disabled:opacity-60"
    >
      <span class="material-icons text-base" *ngIf="enviando"
        >hourglass_top</span
      >
      {{ enviando ? "Guardando..." : "Guardar reajuste" }}
    </button>
  </div>
</form>
